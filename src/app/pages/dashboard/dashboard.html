<div class="dashboard-container">
  <header class="dashboard-header">
    <h1>Dashboard</h1>
    <div class="user-info" *ngIf="user">
      <span>Welcome, {{ user.name }}!</span>
      <button (click)="logout()" class="logout-btn">Logout</button>
    </div>
  </header>

  <div class="dashboard-content">
    <!-- User Profile Section -->
    <section class="profile-section" *ngIf="user">
      <h2>Profile Information</h2>
      <div class="profile-card">
        <p><strong>Name:</strong> {{ user.name }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>
      </div>
    </section>

    <!-- Quick Actions -->
    <section class="quick-actions">
      <h2>Quick Actions</h2>
      <div class="action-buttons">
        <a routerLink="/apply" class="action-btn primary">Submit New Application</a>
        <a routerLink="/" class="action-btn secondary">Browse Jobs</a>
      </div>
    </section>

    <!-- Applications Section -->
    <section class="applications-section">
      <h2>Your Applications</h2>

      <!-- Filter Toolbar -->
      <div class="filter-toolbar" *ngIf="applications.length > 0" style="display:flex; gap:12px; align-items:center; margin:12px 0; flex-wrap:wrap;">
        <label for="positionFilter" style="font-weight:600;">Filter by position:</label>
        <select id="positionFilter" [(ngModel)]="filterPosition" style="padding:8px 10px; border-radius:8px; border:1px solid #e5e7eb;">
          <option value="">All positions</option>
          <option *ngFor="let pos of uniquePositions" [value]="pos">{{ pos }}</option>
        </select>

        <label for="sortBy" style="font-weight:600; margin-left:8px;">Sort by:</label>
        <select id="sortBy" [(ngModel)]="sortBy" style="padding:8px 10px; border-radius:8px; border:1px solid #e5e7eb;">
          <option value="score">Highest Score</option>
          <option value="date">Most Recent</option>
        </select>

        <span style="color:#6b7280; font-size:14px;">Showing {{ sortedApplications.length }} of {{ applications.length }}</span>
      </div>

      <!-- Ranked List (compact) -->
      <div *ngIf="sortedApplications.length > 0" style="background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin-bottom:16px;">
        <h3 style="margin:0 0 8px 0; font-size:16px;">Ranked Matches</h3>
        <ol style="margin:0; padding-left:18px;">
          <li *ngFor="let app of sortedApplications" style="margin:4px 0;">
            <strong>{{ app.fullName }}</strong>
            – {{ (app.scorePercent ?? (app.maxScore ? (100 * (app.score || 0) / app.maxScore) : 0) ) | number:'1.0-0' }}% match
            <span style="color:#6b7280;"> ({{ app.position }}:
              <ng-container *ngIf="app.matchedKeywords?.length; else noSkills">
                {{ (app.matchedKeywords | slice:0:5).join(', ') }}<ng-container *ngIf="app.matchedKeywords.length > 5">, +{{ app.matchedKeywords.length - 5 }} more</ng-container>
              </ng-container>
              <ng-template #noSkills>no matches</ng-template>)
            </span>
          </li>
        </ol>
      </div>
      
      <div *ngIf="applications.length === 0" class="no-applications">
        <p>You haven't submitted any applications yet.</p>
        <a routerLink="/apply" class="action-btn primary">Submit Your First Application</a>
      </div>

      <div *ngIf="applications.length > 0" class="applications-grid">
        <div *ngFor="let app of sortedApplications" class="application-card">
          <div class="application-header" style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
            <div>
              <h3 style="margin:0;">{{ app.position }}</h3>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; font-size:13px; color:#6b7280;">
                <span class="fit-badge" [ngClass]="fitBadgeClass(app.fitLevel)" style="padding:2px 8px; border-radius:9999px; font-weight:600;">{{ app.fitLevel || '—' }} fit</span>
                <span *ngIf="app.scorePercent !== undefined">Score: <strong>{{ app.scorePercent }}%</strong></span>
                <span *ngIf="app.score !== undefined && app.maxScore">({{ app.score }}/{{ app.maxScore }})</span>
              </div>
            </div>
            <span class="status" [class]="getStatusClass(app.status || 'pending')">{{ (app.status || 'pending') | titlecase }}</span>
          </div>
          
          <div class="application-details">
            <p><strong>Name:</strong> {{ app.fullName }}</p>
            <p><strong>Email:</strong> {{ app.email }}</p>
            <p *ngIf="app.phone"><strong>Phone:</strong> {{ app.phone }}</p>
            <p *ngIf="app.experience"><strong>Experience:</strong> {{ app.experience }}</p>
            <p *ngIf="app.resumeFileName"><strong>Resume:</strong> {{ app.resumeFileName }}</p>
            <p><strong>Submitted:</strong> {{ app.submittedAt | date:'short' }}</p>
            <p *ngIf="app.interviewDate"><strong>Interview:</strong> {{ app.interviewDate | date:'medium' }} at {{ app.interviewDate | date:'shortTime' }}</p>

            <p *ngIf="app.matchedKeywords?.length">
              <strong>Matched skills:</strong>
              <span style="display:inline-block; margin-top:4px;">
                <span *ngFor="let k of app.matchedKeywords" style="display:inline-block; background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:9999px; font-size:12px; margin:2px;">{{ k }}</span>
              </span>
            </p>

            <p *ngIf="app.missingMustHaves?.length">
              <strong>Missing must-haves:</strong>
              <span style="color:#b91c1c">{{ app.missingMustHaves.join(', ') }}</span>
            </p>
          </div>

          <!-- Resume Text Collapsible with highlights -->
          <details *ngIf="app.resumeText">
            <summary>View Extracted Resume Text</summary>
            <div style="white-space: pre-wrap; background:#f7f7f7; padding:12px; border-radius:8px; max-height:250px; overflow:auto;" [innerHTML]="highlightResume(app)"></div>
          </details>

          <div class="application-actions">
            <button (click)="deleteApplication(app.id)" class="delete-btn">Delete Application</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Statistics Section -->
    <section class="stats-section" *ngIf="applications.length > 0">
      <h2>Application Statistics</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>{{ applications.length }}</h3>
          <p>Total Applications</p>
        </div>
        <div class="stat-card">
          <h3>{{ pendingCount }}</h3>
          <p>Pending Review</p>
        </div>
        <div class="stat-card">
          <h3>{{ interviewsScheduledCount }}</h3>
          <p>Interviews Scheduled</p>
        </div>
      </div>
      <div *ngIf="upcomingInterviewDates.length > 0" style="margin-top:16px;">
        <h3 style="margin:0 0 8px 0;">Upcoming Interviews</h3>
        <ul style="margin:0; padding-left:18px;">
          <li *ngFor="let iv of upcomingInterviewDates">
            {{ iv.when | date:'mediumDate' }} at {{ iv.when | date:'shortTime' }} — {{ iv.name }} ({{ iv.position }})
          </li>
        </ul>
      </div>
    </section>
  </div>
</div>
